name: Compile and test with clang

on: [push, pull_request]

env:
  PACKAGE_NAME: maliput
  ROS_DISTRO: dashing
  ROS_WS: maliput_ws

jobs:
  compile_and_test:
    name: Compile and test
    runs-on: ubuntu-18.04
    container:
      image: ubuntu:18.04
    steps:
    - uses: actions/checkout@v2
      with:
        path: ${{ env.ROS_WS }}/src/${{ env.PACKAGE_NAME }}
    # use setup-ros action to get vcs, rosdep, and colcon
    - uses: ros-tooling/setup-ros@0.0.25
    - name: clang 8 install
      working-directory: ${{ env.ROS_WS }}
      shell: bash
      run: |
        apt install clang-8 lldb-8 lld-8 clang-format-8 clang-tidy-8 libc++-8-dev libc++abi-8-dev
    - name: update clang alternatives
      working-directory: ${{ env.ROS_WS }}
      shell: bash
      run: |
        update-alternatives \
          --install /usr/bin/clang                 clang                 /usr/bin/clang-8 10\
          --slave   /usr/bin/clang++               clang++               /usr/bin/clang++-8  \
          --slave   /usr/bin/asan_symbolize        asan_symbolize        /usr/bin/asan_symbolize-8 \
          --slave   /usr/bin/c-index-test          c-index-test          /usr/bin/c-index-test-8 \
          --slave   /usr/bin/clang-check           clang-check           /usr/bin/clang-check-8 \
          --slave   /usr/bin/clang-cl              clang-cl              /usr/bin/clang-cl-8 \
          --slave   /usr/bin/clang-cpp             clang-cpp             /usr/bin/clang-cpp-8 \
          --slave   /usr/bin/clang-format          clang-format          /usr/bin/clang-format-8 \
          --slave   /usr/bin/clang-format-diff     clang-format-diff     /usr/bin/clang-format-diff-8 \
          --slave   /usr/bin/clang-import-test     clang-import-test     /usr/bin/clang-import-test-8 \
          --slave   /usr/bin/clang-include-fixer   clang-include-fixer   /usr/bin/clang-include-fixer-8 \
          --slave   /usr/bin/clang-offload-bundler clang-offload-bundler /usr/bin/clang-offload-bundler-8 \
          --slave   /usr/bin/clang-query           clang-query           /usr/bin/clang-query-8 \
          --slave   /usr/bin/clang-rename          clang-rename          /usr/bin/clang-rename-8 \
          --slave   /usr/bin/clang-reorder-fields  clang-reorder-fields  /usr/bin/clang-reorder-fields-8 \
          --slave   /usr/bin/clang-tidy            clang-tidy            /usr/bin/clang-tidy-8 \
          --slave   /usr/bin/lldb                  lldb                  /usr/bin/lldb-8 \
          --slave   /usr/bin/lldb-server           lldb-server           /usr/bin/lldb-server-8
    - name: vcs import
      shell: bash
      working-directory: ${{ env.ROS_WS }}
      run: vcs import src < src/${PACKAGE_NAME}/.github/dependencies.repos
    - run: colcon graph
      shell: bash
      working-directory: ${{ env.ROS_WS }}
    - name: rosdep install
      shell: bash
      working-directory: ${{ env.ROS_WS }}
      run: |
        rosdep update;
        rosdep install  -i -y --rosdistro ${ROS_DISTRO} --skip-keys "pybind11" --from-paths src
    - name: colcon build
      shell: bash
      working-directory: ${{ env.ROS_WS }}
      run: |
        . /opt/ros/${ROS_DISTRO}/setup.bash;
        colcon CC=clang CXX=clang++ build --cmake-args -DCMAKE_LINKER=/usr/bin/llvm-ld --packages-up-to ${PACKAGE_NAME} --event-handlers=console_direct+;
    - name: colcon test
      shell: bash
      working-directory: ${{ env.ROS_WS }}
      run: |
        . /opt/ros/${ROS_DISTRO}/setup.bash;
        colcon test --packages-select ${PACKAGE_NAME} --event-handlers=console_direct+;
        colcon test-result --verbose;
